# 合成水果 - 开发指南

## 项目概述
合成水果是一款基于抖音小程序平台的休闲益智游戏，采用物理引擎实现真实的水果掉落和合成效果。

## 开发环境设置

### 1. 安装抖音开发者工具
- 下载并安装最新版本的抖音开发者工具
- 注册抖音开发者账号并完成认证

### 2. 导入项目
1. 打开抖音开发者工具
2. 选择"导入项目"
3. 选择项目根目录（包含 `game.json` 的目录）
4. 填写项目信息并确认导入

## 配置文件说明

### game.json
```json
{
  "pages": ["game"],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "合成水果",
    "navigationBarTextStyle": "black"
  },
  "networkTimeout": {
    "request": 10000,
    "downloadFile": 10000
  },
  "debug": true
}
```

### project.config.json
```json
{
  "miniprogramRoot": "./",
  "projectname": "fruit-merge-z",
  "description": "合成水果抖音小游戏",
  "appid": "your_app_id_here",
  "setting": {
    "urlCheck": false,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "minified": true
  },
  "compileType": "miniprogram"
}
```

## 运行和调试

### 1. 预览模式
- 在抖音开发者工具中点击"预览"
- 使用抖音APP扫描二维码进行预览
- 查看控制台输出进行调试

### 2. 真机调试
- 点击"真机调试"按钮
- 使用抖音APP扫描二维码
- 可以在开发者工具中实时查看日志和调试信息

### 3. 模拟器调试
- 在开发者工具中直接运行
- 使用模拟器进行基本功能测试

## 代码结构

### 核心文件
- `game.js` - 游戏主入口文件
- `game.json` - 小程序配置文件
- `project.config.json` - 项目配置文件

### 源码目录结构
```
src/
├── config/          # 配置文件
│   └── constants.js  # 游戏常量配置
├── engine/          # 游戏引擎
│   └── physics.js   # 物理引擎
├── game/            # 游戏逻辑
│   ├── gameLogic.js # 主游戏逻辑
│   └── fruit.js     # 水果管理
├── ui/              # 用户界面
│   └── gameUI.js    # 游戏UI组件
├── effects/         # 特效系统
│   └── effectSystem.js
└── douyin/          # 抖音API集成
    └── api.js       # 抖音API封装
```

### 模块依赖关系
1. `game.js` 作为主入口，初始化所有系统
2. `gameLogic.js` 管理游戏状态和逻辑
3. `physics.js` 提供物理模拟
4. `fruit.js` 管理水果对象
5. `gameUI.js` 处理用户界面
6. `api.js` 处理抖音平台集成

## 开发流程

### 1. 功能开发
1. 在对应模块中添加新功能
2. 更新相关配置文件
3. 测试功能是否正常工作
4. 提交代码变更

### 2. 调试流程
1. 使用 `console.log` 输出调试信息
2. 在开发者工具中查看控制台
3. 使用断点调试复杂逻辑
4. 在真机上测试性能表现

### 3. 性能优化
1. 监控帧率和内存使用
2. 优化渲染循环
3. 减少不必要的计算
4. 压缩资源文件

### 4. 测试流程
1. 单元测试各个模块
2. 集成测试游戏流程
3. 性能测试和压力测试
4. 兼容性测试

## 常见问题排查

### 1. 编译错误
**问题**: `"workers"` 字段不能为空字符串
**解决**: 从 `game.json` 中移除 `workers` 字段

### 2. 初始化失败
**问题**: "Cannot read properties of undefined (reading 'width')"
**解决方案**:
1. 检查 `constants.js` 中的 `GAME_CONFIG.CANVAS` 配置
2. 确保 `width` 和 `height` 属性正确定义
3. 验证抖音小程序环境是否正确初始化

**问题**: 游戏初始化失败
**可能原因**:
1. 抖音API未正确初始化
2. 画布创建失败
3. 游戏系统初始化异常
4. 配置文件错误

**排查步骤**:
1. 检查控制台错误信息
2. 验证 `tt` 对象是否可用
3. 确认 `GAME_CONFIG` 配置正确
4. 检查所有依赖模块是否正确加载

### 3. 性能问题
**问题**: 游戏卡顿或帧率低
**解决**:
1. 检查渲染循环是否过于复杂
2. 优化物理计算频率
3. 减少DOM操作
4. 使用对象池管理游戏对象

### 4. API调用失败
**问题**: 抖音API调用返回错误
**解决**:
1. 检查网络连接
2. 验证API权限配置
3. 确认参数格式正确
4. 查看抖音开发者文档

### 5. 资源加载问题
**问题**: 图片或音频资源无法加载
**解决**:
1. 检查资源路径是否正确
2. 确认资源文件存在
3. 验证文件格式支持
4. 检查网络请求权限

## 发布准备

### 1. 代码检查
- 移除调试代码和console.log
- 检查代码规范和注释
- 运行语法检查工具

### 2. 性能测试
- 测试各种设备上的性能表现
- 检查内存使用情况
- 验证加载时间

### 3. 功能测试
- 完整游戏流程测试
- 边界情况测试
- 用户体验测试

### 4. 提交审核
1. 在抖音开发者工具中点击"上传"
2. 填写版本信息和更新说明
3. 提交审核并等待结果

## 技术支持

### 开发文档
- [抖音小程序开发文档](https://developer.open-douyin.com/docs/resource/zh-CN/mini-app/develop/guide/start/introduction)
- [Canvas API文档](https://developer.open-douyin.com/docs/resource/zh-CN/mini-app/develop/api/media/canvas/tt-create-canvas)

### 调试工具
- 抖音开发者工具内置调试器
- 真机调试功能
- 性能分析工具

### 社区支持
- 抖音开发者社区
- 技术交流群
- 官方技术支持

---

## 更新日志

### v1.0.0 (当前版本)
- 完成基础游戏功能
- 实现物理引擎
- 添加水果合成系统
- 集成抖音API
- 修复初始化问题
- 添加错误处理机制

---

## 抖音小游戏运行与发布说明（三消版）

### 1. 在抖音开发者工具运行
- 使用“导入项目”指向本目录（包含 `game.json`）。
- 入口 `game.js` 会在抖音环境中使用 `tt.createCanvas()` 和 `tt.onTouchStart/Move/End`，无需手动绑定。
- 图片由 `src/utils/imageLoader.js` 预加载；音频缺失时由 `src/managers/audioManager.js` 静音降级，确保不崩溃。
- 在模拟器中点击或滑动顶部列投放水果，体验“网格三消”玩法与连锁消除。

### 2. 真机调试
- 在开发者工具点击“预览到手机/真机调试”，扫码运行。
- 若触控不灵敏或帧率偏低，可在 `src/config/constants.js` 调整：
  - `GAMEPLAY.MATCH3.cellSize`（缩小单元格可提升性能）
  - `GAMEPLAY.MATCH3.rows/cols`（降低棋盘规模）
  - 适当减少特效（如需要，可限制粒子数量）。

### 3. 玩法模式切换
- 在 `src/config/constants.js` 设置：
  - `GAMEPLAY.MODE: 'match3'` 使用网格三消（默认）。
  - `GAMEPLAY.MODE: 'physics'` 回到物理堆叠合成（旧玩法）。

### 4. 资源与配置
- 可选添加音频到 `assets/audio/`：`bgm.mp3/merge.mp3/drop.mp3/game_over.mp3/click.mp3`。
- 如不提供音频，运行时会看到 `assets/audio/*.mp3` 加载失败提示，属预期降级，不影响玩法。
- `game.json` 与 `project.config.json` 保持默认即可运行；如需分包或自定义编译选项可按平台文档调整。

### 5. 发布流程摘要
- 在抖音开发者工具完成“代码审查”“性能检测”“权限检查”。
- 准备素材：图标、截图/短视频、玩法说明与版本更新信息。
- 提交审核通过后上线；数据上报可在 `src/douyin/api.js` 的 `reportGameData` 中拓展（分数、连击、时长等）。

### 6. 常见问题
- 看到 `net::ERR_ABORTED ...assets/audio/*.mp3`：资源未提供，已静音降级；如果需要音效，补齐音频文件即可。
- 画面无响应：确认在抖音开发者工具运行而非浏览器；并检查 `game.js` 是否成功创建抖音 Canvas。
- 玩法不生效：确认 `GAMEPLAY.MODE` 是否为 `'match3'`，或重新导入项目以刷新编译缓存。